name: Windows RDP Stabil (No Debloat)

on: workflow_dispatch

jobs:
  rdp-stabil:
    runs-on: windows-latest
    timeout-minutes: 360 # 6 Jam
    
    steps:
    - name: 1. Setup User & RDP
      run: |
        # Set Password
        net user runneradmin "PasswordSuper123!"
        
        # Buka Port RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        
        Write-Host ">>> User: runneradmin | Pass: PasswordSuper123!" -ForegroundColor Green

    - name: 2. Pasang Cloudflare Tunnel
      env:
        CF_TOKEN: ${{ secrets.CF_TOKEN }}
      run: |
        # Download
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        
        # Install Service
        .\cloudflared.exe service install $env:CF_TOKEN
        
        # Start Service
        Set-Service -Name "cloudflared" -Status Running
        
        Write-Host ">>> Tunnel Service Started. Cek Dashboard!" -ForegroundColor Cyan

    - name: 3. Keep Alive (Looping Simpel)
      run: |
        Write-Host ">>> MENJAGA SESI TETAP HIDUP..." -ForegroundColor Yellow
        $i = 0
        while ($true) {
            $i++
            Write-Host "Alive: $i menit..."
            # Gerakin mouse virtual dikit biar ga dikira AFK (pake powershell command simple)
            [Console]::Beep(37, 200) # Bunyi beep kecil di server biar cpu jalan dikit
            Start-Sleep -Seconds 60
        }
